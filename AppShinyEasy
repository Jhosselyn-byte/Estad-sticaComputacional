# ============================================================================
# APLICACI√ìN SHINY: AN√ÅLISIS EASYSTATS COMPLETO + 5 M√ìDULOS T√âCNICOS + 7 IA
# ============================================================================

# INSTALAR PAQUETES FALTANTES
paquetes_necesarios <- c(
  "shiny", "shinydashboard", "easystats", "performance", "parameters",
  "see", "report", "correlation", "modelbased", "effectsize", 
  "bayestestR", "insight", "datawizard", "httr", "jsonlite",
  "ggplot2", "DT", "plotly", "readxl", "shinyWidgets",
  "systemfonts", "ragg", "textshaping", "reshape2", "dplyr",
  "boot", "caret", "car", "MASS", "glmnet", "naniar", "visdat", "corrplot"
)

paquetes_faltantes <- paquetes_necesarios[!paquetes_necesarios %in% installed.packages()[,"Package"]]
if(length(paquetes_faltantes) > 0) {
  install.packages(paquetes_faltantes, dependencies = TRUE)
}

library(shiny)
library(shinydashboard)
library(easystats)
library(performance)
library(parameters)
library(see)
library(report)
library(correlation)
library(modelbased)
library(effectsize)
library(bayestestR)
library(insight)
library(datawizard)
library(httr)
library(jsonlite)
library(ggplot2)
library(DT)
library(plotly)
library(readxl)
library(shinyWidgets)
library(dplyr)
library(boot)
library(caret)
library(car)
library(MASS)
library(glmnet)
library(naniar)
library(visdat)
library(corrplot)

# CONFIGURACI√ìN DE OPENAI API
OPENAI_API_KEY <- "Api OpenAi"

llamar_openai <- function(prompt, max_tokens = 500) {
  tryCatch({
    response <- POST(
      url = "https://api.openai.com/v1/chat/completions",
      add_headers(
        "Authorization" = paste("Bearer", OPENAI_API_KEY),
        "Content-Type" = "application/json"
      ),
      body = toJSON(list(
        model = "gpt-3.5-turbo",
        messages = list(list(role = "user", content = prompt)),
        max_tokens = max_tokens,
        temperature = 0.7
      ), auto_unbox = TRUE),
      encode = "json"
    )
    
    if (status_code(response) == 200) {
      content <- content(response, "parsed")
      return(content$choices[[1]]$message$content)
    } else {
      return(paste("Error API:", status_code(response)))
    }
  }, error = function(e) {
    return(paste("Error de conexi√≥n:", e$message))
  })
}

# ============================================================================
# UI - INTERFAZ
# ============================================================================

ui <- dashboardPage(
  skin = "blue",
  
  dashboardHeader(
    title = "EasyStats Analytics Pro",
    titleWidth = 300
  ),
  
  dashboardSidebar(
    width = 300,
    sidebarMenu(
      id = "tabs",
      menuItem("üì§ Cargar Datos", tabName = "carga", icon = icon("upload")),
      
      # M√ìDULOS T√âCNICOS
      menuItem("üî¨ M√≥dulos T√©cnicos", icon = icon("flask"),
               menuSubItem("1. Ingesta y Calidad", tabName = "modulo1"),
               menuSubItem("2. Modelado", tabName = "modulo2"),
               menuSubItem("3. Inferencia y Remuestreo", tabName = "modulo3"),
               menuSubItem("4. Diagn√≥stico", tabName = "modulo4"),
               menuSubItem("5. Comunicaci√≥n", tabName = "modulo5")
      ),
      
      menuItem("‚öôÔ∏è Configurar Modelo", tabName = "config_modelo", icon = icon("cogs")),
      
      # 10 LIBRER√çAS EASYSTATS
      menuItem("üìä EasyStats (10 Libs)", icon = icon("cube"),
               menuSubItem("1. performance", tabName = "performance"),
               menuSubItem("2. parameters", tabName = "parameters_tab"),
               menuSubItem("3. see (Visualizaci√≥n)", tabName = "see"),
               menuSubItem("4. report", tabName = "report_tab"),
               menuSubItem("5. correlation", tabName = "correlation_tab"),
               menuSubItem("6. modelbased", tabName = "modelbased"),
               menuSubItem("7. effectsize", tabName = "effectsize"),
               menuSubItem("8. bayestestR", tabName = "bayestestr"),
               menuSubItem("9. insight", tabName = "insight_tab"),
               menuSubItem("10. datawizard", tabName = "datawizard")
      ),
      
      menuItem("ü§ñ IA: 7 Funcionalidades", tabName = "openai", icon = icon("robot")),
      menuItem("üìã Reporte Final", tabName = "reporte_final", icon = icon("file-alt"))
    ),
    hr(),
    uiOutput("status_indicator"),
    hr(),
    downloadButton("download_reporte", "üíæ Descargar Todo", 
                   class = "btn-success btn-block")
  ),
  
  dashboardBody(
    tags$head(
      tags$style(HTML("
        .content-wrapper { background-color: #f4f6f9; }
        .box { box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .ai-output { 
          background-color: #e8f4f8; 
          padding: 15px; 
          border-radius: 5px;
          border-left: 4px solid #3c8dbc;
          margin: 10px 0;
        }
        .library-title {
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          padding: 15px;
          border-radius: 5px;
          margin-bottom: 20px;
          text-align: center;
        }
        .modulo-title {
          background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
          color: white;
          padding: 15px;
          border-radius: 5px;
          margin-bottom: 20px;
          text-align: center;
        }
        .success-box {
          background: #d4edda;
          border: 2px solid #28a745;
          padding: 20px;
          border-radius: 10px;
          text-align: center;
        }
      "))
    ),
    
    tabItems(
      # TAB: CARGAR DATOS ==================================================
      tabItem(
        tabName = "carga",
        fluidRow(
          box(
            title = "Cargar tu Dataset",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            fileInput("file", "Selecciona tu archivo (CSV, Excel, TXT):",
                      accept = c(".csv", ".xlsx", ".xls", ".txt")),
            radioButtons("separator", "Separador (para CSV/TXT):",
                         choices = c("Coma" = ",", "Punto y coma" = ";", 
                                     "Tabulador" = "\t"),
                         selected = ",", inline = TRUE),
            checkboxInput("header", "¬øPrimera fila contiene encabezados?", TRUE),
            hr(),
            actionButton("load_example", "Cargar Dataset de Ejemplo (iris)", 
                         icon = icon("database"), class = "btn-info")
          )
        ),
        fluidRow(
          valueBoxOutput("n_obs", width = 3),
          valueBoxOutput("n_vars", width = 3),
          valueBoxOutput("n_numeric", width = 3),
          valueBoxOutput("n_factor", width = 3)
        ),
        fluidRow(
          box(
            title = "Vista Previa de los Datos",
            width = 12,
            status = "info",
            solidHeader = TRUE,
            DTOutput("preview_table")
          )
        ),
        fluidRow(
          box(
            title = "üéØ Pr√≥ximo Paso",
            width = 12,
            status = "success",
            solidHeader = TRUE,
            div(style = "text-align: center; padding: 20px;",
                h3("‚úÖ Datos cargados exitosamente"),
                p("Explora los M√≥dulos T√©cnicos o configura tu modelo"),
                actionButton("go_to_modulo1", "Explorar Calidad de Datos ‚Üí", 
                             class = "btn-primary btn-lg",
                             icon = icon("arrow-right")),
                br(), br(),
                actionButton("go_to_model", "Configurar Modelo ‚Üí", 
                             class = "btn-success btn-lg",
                             icon = icon("arrow-right"))
            )
          )
        )
      ),
      
      # M√ìDULO 1: INGESTA Y CALIDAD =======================================
      tabItem(
        tabName = "modulo1",
        fluidRow(
          box(
            width = 12,
            div(class = "modulo-title",
                h2("üî¨ M√ìDULO 1: INGESTA Y CALIDAD DE DATOS"),
                p("Validaci√≥n, NA, Recodificaci√≥n, Diccionario, Muestreo y Trazabilidad")
            )
          )
        ),
        
        fluidRow(
          box(
            title = "üìä Resumen de Calidad de Datos",
            width = 6,
            status = "primary",
            solidHeader = TRUE,
            verbatimTextOutput("calidad_resumen")
          ),
          box(
            title = "üìà Estad√≠sticas por Variable",
            width = 6,
            status = "info",
            solidHeader = TRUE,
            DTOutput("calidad_stats")
          )
        ),
        
        fluidRow(
          box(
            title = "üîç Visualizaci√≥n de Valores Faltantes (NA)",
            width = 12,
            status = "warning",
            solidHeader = TRUE,
            plotOutput("na_visualization", height = "400px")
          )
        ),
        
        fluidRow(
          box(
            title = "üìö Diccionario de Variables",
            width = 12,
            status = "success",
            solidHeader = TRUE,
            DTOutput("diccionario_vars")
          )
        )
      ),
      
      # M√ìDULO 2: MODELADO ================================================
      tabItem(
        tabName = "modulo2",
        fluidRow(
          box(
            width = 12,
            div(class = "modulo-title",
                h2("üìà M√ìDULO 2: MODELADO Y APRENDIZAJE ESTAD√çSTICO"),
                p("LM/GLM, ANOVA/ANCOVA, Regularizaci√≥n, Modelos Avanzados")
            )
          )
        ),
        
        fluidRow(
          box(
            title = "üéØ Selecci√≥n de Modelo",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            selectInput("model_type", "Tipo de Modelo:",
                        choices = c("Regresi√≥n Lineal (LM)" = "lm",
                                    "Regresi√≥n Generalizada (GLM)" = "glm",
                                    "ANOVA" = "anova")),
            uiOutput("model_config_ui"),
            actionButton("run_advanced_model", "üöÄ Ejecutar Modelo Avanzado",
                         class = "btn-success btn-lg btn-block",
                         icon = icon("play"))
          )
        ),
        
        fluidRow(
          box(
            title = "üìä Resumen del Modelo",
            width = 6,
            status = "info",
            solidHeader = TRUE,
            verbatimTextOutput("model_summary_adv")
          ),
          box(
            title = "üìà M√©tricas de Performance",
            width = 6,
            status = "warning",
            solidHeader = TRUE,
            verbatimTextOutput("model_metrics_adv")
          )
        )
      ),
      
      # M√ìDULO 3: INFERENCIA Y REMUESTREO =================================
      tabItem(
        tabName = "modulo3",
        fluidRow(
          box(
            width = 12,
            div(class = "modulo-title",
                h2("üé≤ M√ìDULO 3: INFERENCIA Y REMUESTREO"),
                p("Bootstrap, Simulaci√≥n, Validaci√≥n Cruzada, M√©tricas")
            )
          )
        ),
        
        fluidRow(
          box(
            title = "üîÑ Bootstrap",
            width = 6,
            status = "primary",
            solidHeader = TRUE,
            numericInput("n_bootstrap", "N√∫mero de r√©plicas Bootstrap:",
                         value = 1000, min = 100, max = 10000, step = 100),
            actionButton("run_bootstrap", "Ejecutar Bootstrap",
                         class = "btn-primary", icon = icon("sync")),
            hr(),
            plotOutput("bootstrap_plot", height = "300px")
          ),
          box(
            title = "üìä Intervalos de Confianza Bootstrap",
            width = 6,
            status = "info",
            solidHeader = TRUE,
            DTOutput("bootstrap_ci")
          )
        ),
        
        fluidRow(
          box(
            title = "‚úÖ Validaci√≥n Cruzada",
            width = 12,
            status = "warning",
            solidHeader = TRUE,
            sliderInput("cv_folds", "N√∫mero de folds (K-Fold CV):",
                        min = 3, max = 10, value = 5, step = 1),
            actionButton("run_cv", "Ejecutar Validaci√≥n Cruzada",
                         class = "btn-warning", icon = icon("check-double")),
            hr(),
            verbatimTextOutput("cv_results")
          )
        )
      ),
      
      # M√ìDULO 4: DIAGN√ìSTICO ==============================================
      tabItem(
        tabName = "modulo4",
        fluidRow(
          box(
            width = 12,
            div(class = "modulo-title",
                h2("üîç M√ìDULO 4: DIAGN√ìSTICO Y ROBUSTEZ"),
                p("Supuestos, Colinealidad, Influencia, Sensibilidad, Outliers")
            )
          )
        ),
        
        fluidRow(
          box(
            title = "üìã Verificaci√≥n de Supuestos",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            plotOutput("assumptions_check", height = "600px")
          )
        ),
        
        fluidRow(
          box(
            title = "üîó An√°lisis de Colinealidad (VIF)",
            width = 6,
            status = "info",
            solidHeader = TRUE,
            verbatimTextOutput("vif_analysis")
          ),
          box(
            title = "üéØ Puntos Influyentes",
            width = 6,
            status = "danger",
            solidHeader = TRUE,
            plotOutput("influence_plot", height = "400px")
          )
        )
      ),
      
      # M√ìDULO 5: COMUNICACI√ìN ============================================
      tabItem(
        tabName = "modulo5",
        fluidRow(
          box(
            width = 12,
            div(class = "modulo-title",
                h2("üì¢ M√ìDULO 5: COMUNICACI√ìN DE RESULTADOS"),
                p("Gr√°ficos Interpretables, Tablas para Informe, Reporte Automatizado")
            )
          )
        ),
        
        fluidRow(
          box(
            title = "üìä Gr√°ficos para Presentaci√≥n",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            selectInput("plot_type", "Tipo de gr√°fico:",
                        choices = c("Residuos" = "residuals",
                                    "Observado vs Predicho" = "fitted")),
            plotOutput("communication_plot", height = "500px")
          )
        )
      ),
      
      # CONFIGURAR MODELO ==================================================
      tabItem(
        tabName = "config_modelo",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("‚öôÔ∏è CONFIGURACI√ìN DEL MODELO"),
                p("Configura tu modelo para usar las 10 librer√≠as de EasyStats")
            )
          )
        ),
        fluidRow(
          box(
            title = "üìä Variables del Modelo",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            uiOutput("variable_selector_main"),
            hr(),
            actionButton("run_model_main", "üöÄ EJECUTAR MODELO",
                         class = "btn-success btn-lg btn-block",
                         style = "height: 60px; font-size: 20px;",
                         icon = icon("play"))
          )
        ),
        fluidRow(
          box(
            title = "üìà Resultados del Modelo",
            width = 12,
            status = "info",
            solidHeader = TRUE,
            verbatimTextOutput("modelo_summary")
          )
        ),
        fluidRow(
          box(
            title = "‚úÖ Estado del Modelo",
            width = 12,
            status = "success",
            solidHeader = TRUE,
            uiOutput("modelo_success_msg")
          )
        )
      ),
      
      # 1. PERFORMANCE =====================================================
      tabItem(
        tabName = "performance",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üìä 1. PERFORMANCE"),
                p("Evaluaci√≥n integral del rendimiento del modelo")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  p("Ve a 'Configurar Modelo' y ejecuta un an√°lisis"),
                  actionButton("go_to_config_perf", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä M√©tricas de Performance",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              verbatimTextOutput("performance_metrics")
            ),
            box(
              title = "üìà Tabla de M√©tricas",
              width = 6,
              status = "success",
              solidHeader = TRUE,
              DTOutput("performance_table")
            )
          ),
          fluidRow(
            box(
              title = "üìâ Gr√°fico de Performance",
              width = 12,
              status = "primary",
              solidHeader = TRUE,
              plotOutput("performance_plot", height = "400px")
            )
          )
        )
      ),
      
      # 2. PARAMETERS ======================================================
      tabItem(
        tabName = "parameters_tab",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üìê 2. PARAMETERS"),
                p("Extracci√≥n y an√°lisis de par√°metros del modelo")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_param", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Tabla de Par√°metros",
              width = 12,
              status = "info",
              solidHeader = TRUE,
              DTOutput("parameters_table")
            )
          ),
          fluidRow(
            box(
              title = "üìà Gr√°fico de Coeficientes",
              width = 12,
              status = "primary",
              solidHeader = TRUE,
              plotOutput("parameters_plot", height = "400px")
            )
          ),
          fluidRow(
            box(
              title = "üìã Resumen Detallado",
              width = 12,
              status = "success",
              solidHeader = TRUE,
              verbatimTextOutput("parameters_summary")
            )
          )
        )
      ),
      
      # 3. SEE =============================================================
      tabItem(
        tabName = "see",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üëÅÔ∏è 3. SEE (Visualizaci√≥n)"),
                p("Visualizaciones avanzadas del modelo")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_see", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Visualizaci√≥n de Par√°metros",
              width = 6,
              status = "primary",
              solidHeader = TRUE,
              plotOutput("see_params_plot", height = "400px")
            ),
            box(
              title = "üìà Diagn√≥stico Visual",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              plotOutput("see_check_plot", height = "400px")
            )
          )
        )
      ),
      
      # 4. REPORT ==========================================================
      tabItem(
        tabName = "report_tab",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üìù 4. REPORT"),
                p("Generaci√≥n autom√°tica de reportes en lenguaje natural")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_report", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìÑ Reporte Completo del Modelo",
              width = 12,
              status = "success",
              solidHeader = TRUE,
              verbatimTextOutput("report_text")
            )
          ),
          fluidRow(
            box(
              title = "üìä Reporte de Performance",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              verbatimTextOutput("report_performance")
            ),
            box(
              title = "üìà Reporte de Par√°metros",
              width = 6,
              status = "primary",
              solidHeader = TRUE,
              verbatimTextOutput("report_parameters")
            )
          )
        )
      ),
      
      # 5. CORRELATION =====================================================
      tabItem(
        tabName = "correlation_tab",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üîó 5. CORRELATION"),
                p("An√°lisis de correlaciones entre variables")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_corr", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Matriz de Correlaci√≥n",
              width = 6,
              status = "primary",
              solidHeader = TRUE,
              plotOutput("correlation_plot", height = "500px")
            ),
            box(
              title = "üìà Tabla de Correlaciones",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              DTOutput("correlation_table")
            )
          )
        )
      ),
      
      # 6. MODELBASED ======================================================
      tabItem(
        tabName = "modelbased",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üéØ 6. MODELBASED"),
                p("Predicciones y estimaciones basadas en el modelo")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_mb", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Predicciones del Modelo",
              width = 6,
              status = "primary",
              solidHeader = TRUE,
              DTOutput("modelbased_predictions")
            ),
            box(
              title = "üìà Gr√°fico de Predicciones",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              plotOutput("modelbased_plot", height = "400px")
            )
          )
        )
      ),
      
      # 7. EFFECTSIZE ======================================================
      tabItem(
        tabName = "effectsize",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üìè 7. EFFECTSIZE"),
                p("Tama√±o del efecto e importancia pr√°ctica")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_es", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Tama√±o del Efecto",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              verbatimTextOutput("effectsize_output")
            ),
            box(
              title = "üìà Interpretaci√≥n",
              width = 6,
              status = "success",
              solidHeader = TRUE,
              verbatimTextOutput("effectsize_interpret")
            )
          )
        )
      ),
      
      # 8. BAYESTESTR ======================================================
      tabItem(
        tabName = "bayestestr",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üé≤ 8. BAYESTESTR"),
                p("An√°lisis bayesiano de los resultados")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_bayes", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä An√°lisis Bayesiano",
              width = 12,
              status = "info",
              solidHeader = TRUE,
              verbatimTextOutput("bayestestr_output")
            )
          )
        )
      ),
      
      # 9. INSIGHT =========================================================
      tabItem(
        tabName = "insight_tab",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üîç 9. INSIGHT"),
                p("Informaci√≥n estructurada sobre el modelo")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero ejecuta un modelo"),
                  actionButton("go_to_config_insight", "Ir a Configurar", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Informaci√≥n del Modelo",
              width = 6,
              status = "info",
              solidHeader = TRUE,
              verbatimTextOutput("insight_model_info")
            ),
            box(
              title = "üìà Variables del Modelo",
              width = 6,
              status = "primary",
              solidHeader = TRUE,
              verbatimTextOutput("insight_variables")
            )
          ),
          fluidRow(
            box(
              title = "üìã Datos del Modelo",
              width = 12,
              status = "success",
              solidHeader = TRUE,
              DTOutput("insight_data")
            )
          )
        )
      ),
      
      # 10. DATAWIZARD =====================================================
      tabItem(
        tabName = "datawizard",
        fluidRow(
          box(
            width = 12,
            div(class = "library-title",
                h2("üßô 10. DATAWIZARD"),
                p("Transformaci√≥n y preparaci√≥n de datos")
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == false",
          fluidRow(
            box(
              width = 12,
              status = "warning",
              solidHeader = TRUE,
              div(style = "text-align: center; padding: 40px;",
                  icon("exclamation-triangle", class = "fa-3x"),
                  h3("‚ö†Ô∏è Primero carga datos"),
                  actionButton("go_to_carga_dw", "Ir a Cargar Datos", 
                               class = "btn-warning btn-lg")
              )
            )
          )
        ),
        
        conditionalPanel(
          condition = "output.modelo_ejecutado == true",
          fluidRow(
            box(
              title = "üìä Estad√≠sticas Descriptivas",
              width = 12,
              status = "info",
              solidHeader = TRUE,
              verbatimTextOutput("datawizard_describe")
            )
          ),
          fluidRow(
            box(
              title = "üìà Estandarizaci√≥n de Datos",
              width = 12,
              status = "primary",
              solidHeader = TRUE,
              DTOutput("datawizard_standardize")
            )
          )
        )
      ),
      
      # TAB IA =============================================================
      tabItem(
        tabName = "openai",
        fluidRow(
          box(
            title = "ü§ñ 7 FUNCIONALIDADES CON INTELIGENCIA ARTIFICIAL",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            div(style = "text-align: center; padding: 20px;",
                h4("Genera an√°lisis autom√°ticos usando IA"),
                p("La IA interpretar√° tus resultados estad√≠sticos y gr√°ficos de EasyStats"),
                actionButton("run_all_ai", "üöÄ EJECUTAR TODAS LAS FUNCIONALIDADES",
                             class = "btn-success btn-lg btn-block",
                             icon = icon("robot"))
            )
          )
        ),
        
        fluidRow(
          box(
            title = "1Ô∏è‚É£ RESUMEN EJECUTIVO",
            width = 12,
            status = "info",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func1", "Generar Resumen", 
                         class = "btn-info", icon = icon("file-text")),
            hr(),
            uiOutput("ai_output1")
          )
        ),
        
        fluidRow(
          box(
            title = "2Ô∏è‚É£ INTERPRETACI√ìN DE COEFICIENTES",
            width = 12,
            status = "warning",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func2", "Interpretar Coeficientes", 
                         class = "btn-warning", icon = icon("chart-line")),
            hr(),
            uiOutput("ai_output2")
          )
        ),
        
        fluidRow(
          box(
            title = "3Ô∏è‚É£ AN√ÅLISIS DE SIGNIFICANCIA",
            width = 12,
            status = "success",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func3", "Analizar Significancia", 
                         class = "btn-success", icon = icon("check-circle")),
            hr(),
            uiOutput("ai_output3")
          )
        ),
        
        fluidRow(
          box(
            title = "4Ô∏è‚É£ INTERPRETACI√ìN DE GR√ÅFICOS",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func4", "Interpretar Gr√°ficos", 
                         class = "btn-primary", icon = icon("chart-bar")),
            hr(),
            uiOutput("ai_output4")
          )
        ),
        
        fluidRow(
          box(
            title = "5Ô∏è‚É£ RECOMENDACIONES METODOL√ìGICAS",
            width = 12,
            status = "danger",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func5", "Generar Recomendaciones", 
                         class = "btn-danger", icon = icon("lightbulb")),
            hr(),
            uiOutput("ai_output5")
          )
        ),
        
        fluidRow(
          box(
            title = "6Ô∏è‚É£ LIMITACIONES DEL AN√ÅLISIS",
            width = 12,
            status = "warning",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func6", "Identificar Limitaciones", 
                         class = "btn-warning", icon = icon("exclamation-triangle")),
            hr(),
            uiOutput("ai_output6")
          )
        ),
        
        fluidRow(
          box(
            title = "7Ô∏è‚É£ CONCLUSIONES Y PR√ìXIMOS PASOS",
            width = 12,
            status = "success",
            solidHeader = TRUE,
            collapsible = TRUE,
            actionButton("ai_func7", "Generar Conclusiones", 
                         class = "btn-success", icon = icon("flag-checkered")),
            hr(),
            uiOutput("ai_output7")
          )
        )
      ),
      
      # REPORTE FINAL ======================================================
      tabItem(
        tabName = "reporte_final",
        fluidRow(
          box(
            title = "üìä RESUMEN EJECUTIVO FINAL",
            width = 12,
            status = "primary",
            solidHeader = TRUE,
            actionButton("generate_final", "üöÄ GENERAR REPORTE COMPLETO",
                         class = "btn-success btn-lg btn-block",
                         icon = icon("file-alt")),
            hr(),
            htmlOutput("final_summary")
          )
        )
      )
    )
  )
)

# ============================================================================
# SERVER
# ============================================================================

server <- function(input, output, session) {
  
  options(shiny.maxRequestSize = 100*1024^2)
  
  # VARIABLES REACTIVAS
  datos <- reactiveVal(NULL)
  datos_original <- reactiveVal(NULL)
  modelo_actual <- reactiveVal(NULL)
  
  output$modelo_ejecutado <- reactive({
    !is.null(modelo_actual())
  })
  outputOptions(output, "modelo_ejecutado", suspendWhenHidden = FALSE)
  
  # STATUS INDICATOR
  output$status_indicator <- renderUI({
    if(is.null(datos())) {
      div(style = "background: #f39c12; color: white; padding: 10px; border-radius: 5px; text-align: center;",
          icon("circle"), " Carga datos primero")
    } else if(is.null(modelo_actual())) {
      div(style = "background: #f39c12; color: white; padding: 10px; border-radius: 5px; text-align: center;",
          icon("circle"), " Datos OK - Ejecuta modelo")
    } else {
      div(style = "background: #00a65a; color: white; padding: 10px; border-radius: 5px; text-align: center;",
          icon("check-circle"), " ¬°Todo listo!")
    }
  })
  
  # CARGAR DATOS
  observeEvent(input$file, {
    req(input$file)
    ext <- tools::file_ext(input$file$name)
    
    tryCatch({
      if (ext %in% c("csv", "txt")) {
        df <- read.csv(input$file$datapath, header = input$header,
                       sep = input$separator, stringsAsFactors = FALSE)
      } else if (ext %in% c("xlsx", "xls")) {
        df <- read_excel(input$file$datapath)
      }
      
      datos(df)
      datos_original(df)
      showNotification("‚úÖ Datos cargados exitosamente", type = "message", duration = 3)
    }, error = function(e) {
      showNotification(paste("‚ùå Error al cargar:", e$message), type = "error")
    })
  })
  
  observeEvent(input$load_example, {
    datos(iris)
    datos_original(iris)
    showNotification("‚úÖ Dataset iris cargado", type = "message")
  })
  
  # OUTPUTS B√ÅSICOS
  output$preview_table <- renderDT({
    req(datos())
    datatable(head(datos(), 100), options = list(scrollX = TRUE, pageLength = 10))
  })
  
  output$n_obs <- renderValueBox({
    req(datos())
    valueBox(nrow(datos()), "Observaciones", icon = icon("table"), color = "blue")
  })
  
  output$n_vars <- renderValueBox({
    req(datos())
    valueBox(ncol(datos()), "Variables", icon = icon("columns"), color = "green")
  })
  
  output$n_numeric <- renderValueBox({
    req(datos())
    valueBox(sum(sapply(datos(), is.numeric)), "Num√©ricas", 
             icon = icon("hashtag"), color = "yellow")
  })
  
  output$n_factor <- renderValueBox({
    req(datos())
    valueBox(sum(sapply(datos(), is.factor)) + sum(sapply(datos(), is.character)), 
             "Categ√≥ricas", icon = icon("tags"), color = "red")
  })
  
  # NAVEGACI√ìN
  observeEvent(input$go_to_modulo1, {
    updateTabItems(session, "tabs", "modulo1")
  })
  
  observeEvent(input$go_to_model, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  # Botones de navegaci√≥n desde EasyStats
  observeEvent(input$go_to_config_perf, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_param, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_see, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_report, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_corr, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_mb, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_es, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_bayes, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_config_insight, {
    updateTabItems(session, "tabs", "config_modelo")
  })
  
  observeEvent(input$go_to_carga_dw, {
    updateTabItems(session, "tabs", "carga")
  })
  
  # ========================================================================
  # M√ìDULO 1: CALIDAD DE DATOS
  # ========================================================================
  
  output$calidad_resumen <- renderPrint({
    req(datos())
    df <- datos()
    cat("=== RESUMEN DE CALIDAD DE DATOS ===\n\n")
    cat("Dimensiones:", nrow(df), "filas x", ncol(df), "columnas\n\n")
    cat("Variables num√©ricas:", sum(sapply(df, is.numeric)), "\n")
    cat("Variables categ√≥ricas:", sum(sapply(df, is.character)) + sum(sapply(df, is.factor)), "\n\n")
    cat("Total de valores faltantes:", sum(is.na(df)), "\n")
    cat("Porcentaje de completitud:", round(100 * (1 - sum(is.na(df))/prod(dim(df))), 2), "%\n\n")
    cat("Filas completas (sin NAs):", sum(complete.cases(df)), "\n")
    cat("Filas con al menos un NA:", sum(!complete.cases(df)), "\n")
  })
  
  output$calidad_stats <- renderDT({
    req(datos())
    df <- datos()
    
    resumen <- data.frame(
      Variable = names(df),
      Tipo = sapply(df, function(x) class(x)[1]),
      NAs = sapply(df, function(x) sum(is.na(x))),
      Porcentaje_NA = round(sapply(df, function(x) 100*sum(is.na(x))/length(x)), 2),
      Unicos = sapply(df, function(x) length(unique(na.omit(x)))),
      stringsAsFactors = FALSE
    )
    
    datatable(resumen, options = list(scrollX = TRUE, pageLength = 15))
  })
  
  output$na_visualization <- renderPlot({
    req(datos())
    tryCatch({
      vis_miss(datos()) + 
        theme_minimal() +
        labs(title = "Mapa de Valores Faltantes (NA)")
    }, error = function(e) {
      plot.new()
      text(0.5, 0.5, "Visualizaci√≥n de NAs no disponible")
    })
  })
  
  output$diccionario_vars <- renderDT({
    req(datos())
    df <- datos()
    
    diccionario <- data.frame(
      Variable = names(df),
      Tipo = sapply(df, function(x) class(x)[1]),
      Ejemplo = sapply(df, function(x) {
        val <- head(na.omit(x), 1)
        if(length(val) > 0) as.character(val[1]) else "NA"
      }),
      Min_Max = sapply(df, function(x) {
        if(is.numeric(x)) {
          paste(round(min(x, na.rm=TRUE), 2), "-", round(max(x, na.rm=TRUE), 2))
        } else {
          paste(length(unique(na.omit(x))), "categor√≠as")
        }
      }),
      stringsAsFactors = FALSE
    )
    
    datatable(diccionario, options = list(scrollX = TRUE, pageLength = 20))
  })
  
  # ========================================================================
  # M√ìDULO 2: MODELADO
  # ========================================================================
  
  output$model_config_ui <- renderUI({
    req(datos())
    df <- datos()
    num_vars <- names(df)[sapply(df, is.numeric)]
    all_vars <- names(df)
    
    if(input$model_type == "glm") {
      tagList(
        selectInput("glm_dep", "Variable dependiente:", choices = num_vars),
        checkboxGroupInput("glm_indep", "Variables independientes:", 
                           choices = num_vars, selected = num_vars[1:min(3, length(num_vars))]),
        selectInput("glm_family", "Familia de distribuci√≥n:",
                    choices = c("gaussian", "binomial", "poisson"))
      )
    } else if(input$model_type == "anova") {
      tagList(
        selectInput("anova_dep", "Variable dependiente:", choices = num_vars),
        selectInput("anova_factor", "Factor (variable categ√≥rica):", choices = all_vars)
      )
    } else {
      tagList(
        selectInput("lm_dep", "Variable dependiente:", choices = num_vars),
        checkboxGroupInput("lm_indep", "Variables independientes:", 
                           choices = num_vars, selected = num_vars[1:min(3, length(num_vars))])
      )
    }
  })
  
  observeEvent(input$run_advanced_model, {
    req(datos())
    
    df <- datos()
    
    withProgress(message = 'Ejecutando modelo...', value = 0.5, {
      tryCatch({
        if(input$model_type == "lm") {
          req(input$lm_dep, input$lm_indep)
          formula_str <- paste(input$lm_dep, "~", paste(input$lm_indep, collapse = " + "))
          modelo <- lm(as.formula(formula_str), data = df)
          
        } else if(input$model_type == "glm") {
          req(input$glm_dep, input$glm_indep)
          formula_str <- paste(input$glm_dep, "~", paste(input$glm_indep, collapse = " + "))
          modelo <- glm(as.formula(formula_str), data = df, family = input$glm_family)
          
        } else if(input$model_type == "anova") {
          req(input$anova_dep, input$anova_factor)
          formula_str <- paste(input$anova_dep, "~", input$anova_factor)
          modelo <- aov(as.formula(formula_str), data = df)
        }
        
        modelo_actual(modelo)
        
        showNotification("‚úÖ Modelo ejecutado exitosamente", type = "message")
        
        output$model_summary_adv <- renderPrint({
          summary(modelo)
        })
        
        output$model_metrics_adv <- renderPrint({
          performance(modelo)
        })
        
      }, error = function(e) {
        showNotification(paste("‚ùå Error:", e$message), type = "error")
      })
    })
  })
  
  # ========================================================================
  # M√ìDULO 3: INFERENCIA Y REMUESTREO
  # ========================================================================
  
  observeEvent(input$run_bootstrap, {
    req(modelo_actual())
    
    withProgress(message = 'Ejecutando bootstrap...', value = 0, {
      tryCatch({
        modelo <- modelo_actual()
        
        boot_fn <- function(data, indices) {
          d <- data[indices, ]
          fit <- update(modelo, data = d)
          return(coef(fit))
        }
        
        boot_results <- boot(data = modelo$model, statistic = boot_fn, 
                             R = input$n_bootstrap)
        
        output$bootstrap_plot <- renderPlot({
          par(mfrow = c(2, 2))
          for(i in seq_len(min(4, ncol(boot_results$t)))) {
            hist(boot_results$t[, i], main = names(coef(modelo))[i],
                 xlab = "Valor", col = "skyblue", breaks = 30)
            abline(v = boot_results$t0[i], col = "red", lwd = 2)
          }
          par(mfrow = c(1, 1))
        })
        
        output$bootstrap_ci <- renderDT({
          ci_results <- data.frame(
            Parametro = names(coef(modelo)),
            Estimado = coef(modelo),
            Bootstrap_Mean = apply(boot_results$t, 2, mean),
            CI_Lower = apply(boot_results$t, 2, quantile, 0.025),
            CI_Upper = apply(boot_results$t, 2, quantile, 0.975)
          )
          datatable(ci_results, options = list(scrollX = TRUE))
        })
        
        showNotification("‚úÖ Bootstrap completado", type = "message")
      }, error = function(e) {
        showNotification(paste("‚ùå Error:", e$message), type = "error")
      })
    })
  })
  
  observeEvent(input$run_cv, {
    req(modelo_actual(), datos())
    
    withProgress(message = 'Ejecutando validaci√≥n cruzada...', value = 0.5, {
      tryCatch({
        df <- datos()
        modelo <- modelo_actual()
        
        folds <- createFolds(seq_len(nrow(df)), k = input$cv_folds)
        
        r2_values <- numeric(input$cv_folds)
        rmse_values <- numeric(input$cv_folds)
        
        for(i in seq_len(input$cv_folds)) {
          train_data <- df[-folds[[i]], ]
          test_data <- df[folds[[i]], ]
          
          modelo_cv <- update(modelo, data = train_data)
          
          pred <- predict(modelo_cv, newdata = test_data)
          actual <- test_data[[all.vars(formula(modelo))[1]]]
          
          r2_values[i] <- cor(pred, actual)^2
          rmse_values[i] <- sqrt(mean((pred - actual)^2))
        }
        
        output$cv_results <- renderPrint({
          cat("=== RESULTADOS DE VALIDACI√ìN CRUZADA ===\n\n")
          cat("K-Folds:", input$cv_folds, "\n\n")
          cat("R¬≤ por fold:\n")
          print(round(r2_values, 4))
          cat("\nR¬≤ promedio:", round(mean(r2_values), 4), "\n")
          cat("R¬≤ desviaci√≥n est√°ndar:", round(sd(r2_values), 4), "\n\n")
          cat("RMSE por fold:\n")
          print(round(rmse_values, 4))
          cat("\nRMSE promedio:", round(mean(rmse_values), 4), "\n")
          cat("RMSE desviaci√≥n est√°ndar:", round(sd(rmse_values), 4), "\n")
        })
        
        showNotification("‚úÖ Validaci√≥n cruzada completada", type = "message")
      }, error = function(e) {
        showNotification(paste("‚ùå Error:", e$message), type = "error")
      })
    })
  })
  
  # ========================================================================
  # M√ìDULO 4: DIAGN√ìSTICO
  # ========================================================================
  
  output$assumptions_check <- renderPlot({
    req(modelo_actual())
    tryCatch({
      check_model(modelo_actual())
    }, error = function(e) {
      par(mfrow = c(2, 2))
      plot(modelo_actual())
      par(mfrow = c(1, 1))
    })
  })
  
  output$vif_analysis <- renderPrint({
    req(modelo_actual())
    tryCatch({
      vif_vals <- vif(modelo_actual())
      cat("=== AN√ÅLISIS DE COLINEALIDAD (VIF) ===\n\n")
      cat("Regla: VIF < 5 (ideal), VIF < 10 (aceptable)\n\n")
      print(vif_vals)
      cat("\n")
      if(any(vif_vals > 10)) {
        cat("‚ö†Ô∏è ADVERTENCIA: Colinealidad severa detectada\n")
      } else if(any(vif_vals > 5)) {
        cat("‚ö†Ô∏è Colinealidad moderada detectada\n")
      } else {
        cat("‚úÖ No hay problemas de colinealidad\n")
      }
    }, error = function(e) {
      cat("VIF no disponible para este tipo de modelo")
    })
  })
  
  output$influence_plot <- renderPlot({
    req(modelo_actual())
    
    modelo <- modelo_actual()
    cooksd <- cooks.distance(modelo)
    
    plot(cooksd, pch = 19, cex = 0.5,
         main = "Distancia de Cook (Puntos Influyentes)",
         ylab = "Distancia de Cook", xlab = "Observaci√≥n")
    abline(h = 4/nrow(modelo$model), col = "red", lty = 2)
  })
  
  # ========================================================================
  # M√ìDULO 5: COMUNICACI√ìN
  # ========================================================================
  
  output$communication_plot <- renderPlot({
    req(modelo_actual())
    
    modelo <- modelo_actual()
    
    if(input$plot_type == "residuals") {
      df <- data.frame(
        Fitted = fitted(modelo),
        Residuals = residuals(modelo)
      )
      
      ggplot(df, aes(x = Fitted, y = Residuals)) +
        geom_point(alpha = 0.5) +
        geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
        geom_smooth(se = TRUE) +
        theme_minimal() +
        labs(title = "Gr√°fico de Residuos",
             x = "Valores Ajustados", y = "Residuos")
    } else {
      df <- data.frame(
        Observado = modelo$model[[1]],
        Predicho = fitted(modelo)
      )
      
      ggplot(df, aes(x = Observado, y = Predicho)) +
        geom_point(alpha = 0.5) +
        geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
        geom_smooth(method = "lm", se = TRUE, color = "blue") +
        theme_minimal() +
        labs(title = "Observado vs Predicho",
             x = "Valores Observados", y = "Valores Predichos")
    }
  }, height = 500)
  
  # ========================================================================
  # CONFIGURAR MODELO PRINCIPAL
  # ========================================================================
  
  output$variable_selector_main <- renderUI({
    req(datos())
    df <- datos()
    num_vars <- names(df)[sapply(df, is.numeric)]
    
    if(length(num_vars) < 2) {
      div(style = "background: #f39c12; color: white; padding: 20px; border-radius: 5px;",
          h4(icon("exclamation-triangle"), " Advertencia"),
          p("Necesitas al menos 2 variables num√©ricas")
      )
    } else {
      tagList(
        h4("üìä Configuraci√≥n del Modelo:"),
        helpText("Variables recomendadas de tu base de datos:"),
        tags$ul(
          tags$li("Y (Dependiente): Peso, Talla, PTZ, ZTE, ZPE"),
          tags$li("X (Independientes): EdadMeses, Sexo, Juntos, SIS, Suplementacion")
        ),
        hr(),
        selectInput("dep_var", "Variable Dependiente (Y):",
                    choices = num_vars,
                    selected = num_vars[1]),
        checkboxGroupInput("indep_vars", "Variables Independientes (X):",
                           choices = num_vars,
                           selected = num_vars[2:min(5, length(num_vars))])
      )
    }
  })
  
  observeEvent(input$run_model_main, {
    req(datos(), input$dep_var, input$indep_vars)
    
    df <- datos()
    formula_str <- paste(input$dep_var, "~", 
                         paste(input$indep_vars, collapse = " + "))
    
    withProgress(message = 'üöÄ Ejecutando modelo...', value = 0.5, {
      tryCatch({
        modelo <- lm(as.formula(formula_str), data = df)
        modelo_actual(modelo)
        
        showNotification("‚úÖ ¬°Modelo ejecutado exitosamente!", type = "message", duration = 5)
        
        output$modelo_summary <- renderPrint({
          summary(modelo)
        })
        
        output$modelo_success_msg <- renderUI({
          perf <- performance(modelo)
          params <- parameters(modelo)
          
          div(class = "success-box",
              icon("check-circle", class = "fa-3x", style = "color: #28a745;"),
              h3("¬°Modelo Creado Exitosamente!"),
              hr(),
              tags$ul(style = "text-align: left; display: inline-block;",
                      tags$li(strong("R¬≤ ="), round(perf$R2, 4)),
                      tags$li(strong("Variables significativas:"), sum(params$p < 0.05)),
                      tags$li(strong("F√≥rmula:"), formula_str)
              ),
              hr(),
              h4("‚úÖ Ahora puedes explorar las 10 librer√≠as de EasyStats"),
              p("Ve al men√∫ lateral ‚Üí üìä EasyStats (10 Libs)")
          )
        })
        
      }, error = function(e) {
        showNotification(paste("‚ùå Error:", e$message), type = "error")
      })
    })
  })
  
  # ========================================================================
  # EASYSTATS: 1. PERFORMANCE
  # ========================================================================
  
  output$performance_metrics <- renderPrint({
    req(modelo_actual())
    print(performance(modelo_actual()))
  })
  
  output$performance_table <- renderDT({
    req(modelo_actual())
    perf <- performance(modelo_actual())
    df_perf <- data.frame(
      Metrica = names(perf),
      Valor = as.numeric(perf)
    )
    datatable(df_perf, options = list(scrollX = TRUE, pageLength = 10))
  })
  
  output$performance_plot <- renderPlot({
    req(modelo_actual())
    tryCatch({
      plot(check_model(modelo_actual(), check = "pp_check"))
    }, error = function(e) {
      plot.new()
      text(0.5, 0.5, "Gr√°fico no disponible para este modelo")
    })
  })
  
  # ========================================================================
  # EASYSTATS: 2. PARAMETERS
  # ========================================================================
  
  output$parameters_table <- renderDT({
    req(modelo_actual())
    params <- parameters(modelo_actual())
    datatable(params, options = list(scrollX = TRUE, pageLength = 10))
  })
  
  output$parameters_plot <- renderPlot({
    req(modelo_actual())
    tryCatch({
      plot(parameters(modelo_actual()))
    }, error = function(e) {
      params <- parameters(modelo_actual())
      barplot(params$Coefficient, 
              names.arg = params$Parameter,
              las = 2,
              col = "steelblue",
              main = "Coeficientes del Modelo",
              ylab = "Valor")
    })
  })
  
  output$parameters_summary <- renderPrint({
    req(modelo_actual())
    params <- parameters(modelo_actual())
    cat("=== RESUMEN DE PAR√ÅMETROS ===\n\n")
    cat("Total de par√°metros:", nrow(params), "\n")
    cat("Par√°metros significativos (p < 0.05):", sum(params$p < 0.05, na.rm = TRUE), "\n\n")
    print(params)
  })
  
  # ========================================================================
  # EASYSTATS: 3. SEE
  # ========================================================================
  
  output$see_params_plot <- renderPlot({
    req(modelo_actual())
    tryCatch({
      plot(parameters(modelo_actual()))
    }, error = function(e) {
      plot.new()
      text(0.5, 0.5, "Visualizaci√≥n no disponible")
    })
  })
  
  output$see_check_plot <- renderPlot({
    req(modelo_actual())
    tryCatch({
      check <- check_model(modelo_actual())
      plot(check)
    }, error = function(e) {
      par(mfrow = c(2, 2))
      plot(modelo_actual())
      par(mfrow = c(1, 1))
    })
  })
  
  # ========================================================================
  # EASYSTATS: 4. REPORT
  # ========================================================================
  
  output$report_text <- renderPrint({
    req(modelo_actual())
    tryCatch({
      print(report(modelo_actual()))
    }, error = function(e) {
      cat("Reporte no disponible para este tipo de modelo")
    })
  })
  
  output$report_performance <- renderPrint({
    req(modelo_actual())
    tryCatch({
      print(report(performance(modelo_actual())))
    }, error = function(e) {
      cat("Reporte de performance no disponible")
    })
  })
  
  output$report_parameters <- renderPrint({
    req(modelo_actual())
    tryCatch({
      print(report(parameters(modelo_actual())))
    }, error = function(e) {
      cat("Reporte de par√°metros no disponible")
    })
  })
  
  # ========================================================================
  # EASYSTATS: 5. CORRELATION
  # ========================================================================
  
  output$correlation_plot <- renderPlot({
    req(modelo_actual())
    tryCatch({
      df <- get_data(modelo_actual())
      vars <- find_variables(modelo_actual())
      
      if(length(vars$conditional) > 1) {
        pred_data <- df[, vars$conditional]
        if(all(sapply(pred_data, is.numeric))) {
          cor_matrix <- cor(pred_data, use = "complete.obs")
          corrplot(cor_matrix, method = "color", type = "upper",
                   addCoef.col = "black", tl.col = "black",
                   title = "Correlaci√≥n entre Predictores")
        }
      }
    }, error = function(e) {
      plot.new()
      text(0.5, 0.5, "Matriz de correlaci√≥n no disponible")
    })
  })
  
  output$correlation_table <- renderDT({
    req(modelo_actual())
    tryCatch({
      df <- get_data(modelo_actual())
      vars <- find_variables(modelo_actual())
      
      if(length(vars$conditional) > 1) {
        pred_data <- df[, vars$conditional]
        if(all(sapply(pred_data, is.numeric))) {
          corr_result <- correlation(pred_data)
          datatable(as.data.frame(corr_result), options = list(scrollX = TRUE))
        }
      }
    }, error = function(e) {
      datatable(data.frame(Mensaje = "Correlaciones no disponibles"))
    })
  })
  
  # ========================================================================
  # EASYSTATS: 6. MODELBASED
  # ========================================================================
  
  output$modelbased_predictions <- renderDT({
    req(modelo_actual())
    tryCatch({
      preds <- estimate_expectation(modelo_actual())
      datatable(head(preds, 50), options = list(scrollX = TRUE, pageLength = 10))
    }, error = function(e) {
      df <- data.frame(
        Observado = modelo_actual()$model[[1]],
        Predicho = fitted(modelo_actual()),
        Residuo = residuals(modelo_actual())
      )
      datatable(head(df, 50), options = list(scrollX = TRUE, pageLength = 10))
    })
  })
  
  output$modelbased_plot <- renderPlot({
    req(modelo_actual())
    df <- data.frame(
      Observado = modelo_actual()$model[[1]],
      Predicho = fitted(modelo_actual())
    )
    
    ggplot(df, aes(x = Observado, y = Predicho)) +
      geom_point(alpha = 0.5, color = "steelblue") +
      geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed") +
      theme_minimal() +
      labs(title = "Predicciones del Modelo",
           x = "Valores Observados", y = "Valores Predichos")
  })
  
  # ========================================================================
  # EASYSTATS: 7. EFFECTSIZE
  # ========================================================================
  
  output$effectsize_output <- renderPrint({
    req(modelo_actual())
    tryCatch({
      es <- effectsize(modelo_actual())
      print(es)
    }, error = function(e) {
      cat("Tama√±o del efecto no disponible para este modelo\n\n")
      cat("R¬≤ del modelo:", performance(modelo_actual())$R2)
    })
  })
  
  output$effectsize_interpret <- renderPrint({
    req(modelo_actual())
    tryCatch({
      es <- effectsize(modelo_actual())
      cat("=== INTERPRETACI√ìN DEL TAMA√ëO DEL EFECTO ===\n\n")
      cat("Reglas generales:\n")
      cat("- Peque√±o: 0.01 - 0.06\n")
      cat("- Mediano: 0.06 - 0.14\n")
      cat("- Grande: > 0.14\n\n")
      print(interpret_r2(performance(modelo_actual())$R2))
    }, error = function(e) {
      cat("Interpretaci√≥n no disponible")
    })
  })
  
  # ========================================================================
  # EASYSTATS: 8. BAYESTESTR
  # ========================================================================
  
  output$bayestestr_output <- renderPrint({
    req(modelo_actual())
    tryCatch({
      bay <- bayesfactor_parameters(modelo_actual())
      cat("=== AN√ÅLISIS BAYESIANO ===\n\n")
      print(bay)
    }, error = function(e) {
      cat("An√°lisis bayesiano no disponible para modelos frecuentistas\n\n")
      cat("Convierte a an√°lisis bayesiano para obtener:\n")
      cat("- Factores de Bayes\n")
      cat("- Intervalos de credibilidad\n")
      cat("- Probabilidades posteriores\n")
    })
  })
  
  # ========================================================================
  # EASYSTATS: 9. INSIGHT
  # ========================================================================
  
  output$insight_model_info <- renderPrint({
    req(modelo_actual())
    cat("=== INFORMACI√ìN DEL MODELO ===\n\n")
    info <- model_info(modelo_actual())
    print(info)
  })
  
  output$insight_variables <- renderPrint({
    req(modelo_actual())
    cat("=== VARIABLES DEL MODELO ===\n\n")
    vars <- find_variables(modelo_actual())
    print(vars)
  })
  
  output$insight_data <- renderDT({
    req(modelo_actual())
    datos_modelo <- get_data(modelo_actual())
    datatable(head(datos_modelo, 100), options = list(scrollX = TRUE, pageLength = 10))
  })
  
  # ========================================================================
  # EASYSTATS: 10. DATAWIZARD
  # ========================================================================
  
  output$datawizard_describe <- renderPrint({
    req(datos())
    df <- datos()
    num_vars <- df[, sapply(df, is.numeric)]
    if(ncol(num_vars) > 0) {
      describe_distribution(num_vars)
    } else {
      cat("No hay variables num√©ricas para describir")
    }
  })
  
  output$datawizard_standardize <- renderDT({
    req(datos())
    df <- datos()
    num_vars <- df[, sapply(df, is.numeric)]
    if(ncol(num_vars) > 0) {
      stand_data <- standardize(num_vars)
      datatable(head(stand_data, 50), options = list(scrollX = TRUE, pageLength = 10))
    } else {
      datatable(data.frame(Mensaje = "No hay variables num√©ricas"))
    }
  })
  
  # ========================================================================
  # IA: 7 FUNCIONALIDADES
  # ========================================================================
  
  # Ejecutar todas las funcionalidades
  observeEvent(input$run_all_ai, {
    click("ai_func1")
    Sys.sleep(0.5)
    click("ai_func2")
    Sys.sleep(0.5)
    click("ai_func3")
    Sys.sleep(0.5)
    click("ai_func4")
    Sys.sleep(0.5)
    click("ai_func5")
    Sys.sleep(0.5)
    click("ai_func6")
    Sys.sleep(0.5)
    click("ai_func7")
  })
  
  # 1. RESUMEN EJECUTIVO
  observeEvent(input$ai_func1, {
    req(datos(), modelo_actual())
    
    withProgress(message = 'ü§ñ IA generando resumen...', value = 0.5, {
      df <- datos()
      perf <- performance(modelo_actual())
      params <- parameters(modelo_actual())
      
      prompt <- sprintf(
        "Genera un resumen ejecutivo profesional de 4-5 oraciones para este an√°lisis estad√≠stico:
        
        Dataset: %d observaciones, %d variables
        R¬≤ del modelo: %.4f
        Variables significativas (p<0.05): %d de %d
        Variables en el modelo: %s
        
        Enf√≥cate en los hallazgos clave y su relevancia pr√°ctica.",
        nrow(df), ncol(df), perf$R2,
        sum(params$p < 0.05, na.rm = TRUE), nrow(params),
        paste(params$Parameter[1:min(3, nrow(params))], collapse=", ")
      )
      
      resultado <- llamar_openai(prompt, 400)
      
      output$ai_output1 <- renderUI({
        div(class = "ai-output",
            icon("check-circle", style="color: #28a745;"), 
            strong(" RESUMEN EJECUTIVO:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # 2. INTERPRETACI√ìN DE COEFICIENTES
  observeEvent(input$ai_func2, {
    req(modelo_actual())
    
    withProgress(message = 'ü§ñ IA interpretando coeficientes...', value = 0.5, {
      params <- parameters(modelo_actual())
      
      coefs_info <- paste(
        sprintf("%s: Œ≤=%.4f, p=%.4f", 
                params$Parameter, 
                params$Coefficient, 
                params$p),
        collapse = "\n"
      )
      
      prompt <- sprintf(
        "Interpreta estos coeficientes de regresi√≥n en lenguaje claro y profesional:
        
        %s
        
        Para cada coeficiente significativo (p<0.05), explica:
        1. Qu√© significa el valor
        2. La direcci√≥n y magnitud del efecto
        3. Su relevancia pr√°ctica",
        coefs_info
      )
      
      resultado <- llamar_openai(prompt, 500)
      
      output$ai_output2 <- renderUI({
        div(class = "ai-output",
            icon("chart-line", style="color: #ffc107;"), 
            strong(" INTERPRETACI√ìN DE COEFICIENTES:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # 3. AN√ÅLISIS DE SIGNIFICANCIA
  observeEvent(input$ai_func3, {
    req(modelo_actual())
    
    withProgress(message = 'ü§ñ IA analizando significancia...', value = 0.5, {
      params <- parameters(modelo_actual())
      perf <- performance(modelo_actual())
      
      sig_vars <- params$Parameter[params$p < 0.05]
      non_sig_vars <- params$Parameter[params$p >= 0.05]
      
      prompt <- sprintf(
        "Analiza la significancia estad√≠stica de este modelo:
        
        R¬≤ = %.4f
        Variables significativas (p<0.05): %s
        Variables NO significativas: %s
        
        Explica:
        1. Qu√© implica el valor de R¬≤
        2. La importancia de las variables significativas
        3. Qu√© hacer con las variables no significativas
        4. Limitaciones de la significancia estad√≠stica",
        perf$R2,
        paste(sig_vars, collapse=", "),
        paste(non_sig_vars, collapse=", ")
      )
      
      resultado <- llamar_openai(prompt, 500)
      
      output$ai_output3 <- renderUI({
        div(class = "ai-output",
            icon("check-circle", style="color: #28a745;"), 
            strong(" AN√ÅLISIS DE SIGNIFICANCIA:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # 4. INTERPRETACI√ìN DE GR√ÅFICOS
  observeEvent(input$ai_func4, {
    req(modelo_actual())
    
    withProgress(message = 'ü§ñ IA interpretando gr√°ficos...', value = 0.5, {
      perf <- performance(modelo_actual())
      
      # Informaci√≥n sobre residuos
      res <- residuals(modelo_actual())
      res_mean <- mean(res)
      res_sd <- sd(res)
      res_max <- max(abs(res))
      
      prompt <- sprintf(
        "Interpreta los gr√°ficos de diagn√≥stico de este modelo de regresi√≥n:
        
        Informaci√≥n del modelo:
        - R¬≤ = %.4f
        - Media de residuos: %.4f (deber√≠a ser ~0)
        - Desviaci√≥n est√°ndar de residuos: %.4f
        - Residuo m√°ximo (absoluto): %.4f
        
        Los gr√°ficos principales son:
        1. Residuos vs Valores ajustados (detecta heterocedasticidad)
        2. Q-Q plot (eval√∫a normalidad)
        3. Scale-Location (homogeneidad de varianza)
        4. Residuos vs Leverage (puntos influyentes)
        
        Explica qu√© buscar en cada gr√°fico y qu√© indican los valores actuales.",
        perf$R2, res_mean, res_sd, res_max
      )
      
      resultado <- llamar_openai(prompt, 550)
      
      output$ai_output4 <- renderUI({
        div(class = "ai-output",
            icon("chart-bar", style="color: #007bff;"), 
            strong(" INTERPRETACI√ìN DE GR√ÅFICOS:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # 5. RECOMENDACIONES METODOL√ìGICAS
  observeEvent(input$ai_func5, {
    req(modelo_actual(), datos())
    
    withProgress(message = 'ü§ñ IA generando recomendaciones...', value = 0.5, {
      df <- datos()
      perf <- performance(modelo_actual())
      params <- parameters(modelo_actual())
      
      prompt <- sprintf(
        "Proporciona 5-6 recomendaciones metodol√≥gicas espec√≠ficas para mejorar este an√°lisis:
        
        Contexto:
        - N = %d observaciones
        - Variables en modelo: %d
        - R¬≤ = %.4f
        - Variables significativas: %d
        
        Recomienda sobre:
        1. Transformaciones de variables
        2. Inclusi√≥n/exclusi√≥n de predictores
        3. Interacciones a explorar
        4. Diagn√≥sticos adicionales
        5. Validaci√≥n del modelo
        6. Pr√≥ximos pasos anal√≠ticos",
        nrow(df), nrow(params), perf$R2, sum(params$p < 0.05, na.rm = TRUE)
      )
      
      resultado <- llamar_openai(prompt, 550)
      
      output$ai_output5 <- renderUI({
        div(class = "ai-output",
            icon("lightbulb", style="color: #dc3545;"), 
            strong(" RECOMENDACIONES METODOL√ìGICAS:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # 6. LIMITACIONES DEL AN√ÅLISIS
  observeEvent(input$ai_func6, {
    req(modelo_actual(), datos())
    
    withProgress(message = 'ü§ñ IA identificando limitaciones...', value = 0.5, {
      df <- datos()
      perf <- performance(modelo_actual())
      
      n_obs <- nrow(df)
      n_na <- sum(is.na(df))
      
      prompt <- sprintf(
        "Identifica 5-6 limitaciones importantes de este an√°lisis estad√≠stico:
        
        Caracter√≠sticas:
        - Tama√±o muestral: %d
        - R¬≤: %.4f
        - Valores faltantes en dataset: %d
        - Tipo de modelo: Regresi√≥n lineal
        
        Discute limitaciones sobre:
        1. Supuestos del modelo
        2. Validez externa/generalizaci√≥n
        3. Causalidad vs correlaci√≥n
        4. Tama√±o muestral
        5. Variables omitidas
        6. Calidad de los datos",
        n_obs, perf$R2, n_na
      )
      
      resultado <- llamar_openai(prompt, 550)
      
      output$ai_output6 <- renderUI({
        div(class = "ai-output",
            icon("exclamation-triangle", style="color: #ffc107;"), 
            strong(" LIMITACIONES DEL AN√ÅLISIS:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # 7. CONCLUSIONES Y PR√ìXIMOS PASOS
  observeEvent(input$ai_func7, {
    req(modelo_actual(), datos())
    
    withProgress(message = 'ü§ñ IA generando conclusiones...', value = 0.5, {
      perf <- performance(modelo_actual())
      params <- parameters(modelo_actual())
      
      prompt <- sprintf(
        "Genera conclusiones finales y pr√≥ximos pasos para este an√°lisis:
        
        Resultados clave:
        - R¬≤: %.4f
        - Variables significativas: %s
        
        Proporciona:
        1. S√≠ntesis de hallazgos principales (2-3 puntos)
        2. Implicaciones pr√°cticas
        3. Respuesta a la pregunta de investigaci√≥n
        4. 3-4 pr√≥ximos pasos concretos para continuar el an√°lisis
        
        S√© espec√≠fico y orientado a la acci√≥n.",
        perf$R2,
        paste(params$Parameter[params$p < 0.05][1:min(3, sum(params$p < 0.05))], collapse=", ")
      )
      
      resultado <- llamar_openai(prompt, 550)
      
      output$ai_output7 <- renderUI({
        div(class = "ai-output",
            icon("flag-checkered", style="color: #28a745;"), 
            strong(" CONCLUSIONES Y PR√ìXIMOS PASOS:"),
            hr(),
            tags$p(style="text-align: justify;", resultado))
      })
    })
  })
  
  # ========================================================================
  # REPORTE FINAL
  # ========================================================================
  
  observeEvent(input$generate_final, {
    req(datos(), modelo_actual())
    
    output$final_summary <- renderUI({
      df <- datos()
      perf <- performance(modelo_actual())
      params <- parameters(modelo_actual())
      
      HTML(paste0(
        "<div style='background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);'>",
        "<h2 style='color: #007bff; text-align: center;'>üìä REPORTE FINAL DE AN√ÅLISIS</h2>",
        "<hr style='border: 2px solid #007bff;'>",
        
        "<h3 style='color: #28a745;'>üìã DATASET</h3>",
        "<ul style='font-size: 16px;'>",
        "<li><strong>Observaciones:</strong> ", nrow(df), "</li>",
        "<li><strong>Variables:</strong> ", ncol(df), "</li>",
        "<li><strong>Variables num√©ricas:</strong> ", sum(sapply(df, is.numeric)), "</li>",
        "</ul>",
        
        "<h3 style='color: #007bff;'>üìà MODELO</h3>",
        "<ul style='font-size: 16px;'>",
        "<li><strong>R¬≤:</strong> ", round(perf$R2, 4), " (", 
        round(perf$R2 * 100, 2), "% de varianza explicada)</li>",
        "<li><strong>R¬≤ Ajustado:</strong> ", round(perf$R2_adjusted, 4), "</li>",
        "<li><strong>AIC:</strong> ", round(perf$AIC, 2), "</li>",
        "<li><strong>Variables significativas:</strong> ", sum(params$p < 0.05, na.rm = TRUE), 
        " de ", nrow(params), "</li>",
        "</ul>",
        
        "<h3 style='color: #ffc107;'>‚úÖ ACCIONES COMPLETADAS</h3>",
        "<ul style='font-size: 16px;'>",
        "<li>‚úîÔ∏è An√°lisis de calidad de datos</li>",
        "<li>‚úîÔ∏è Modelado estad√≠stico</li>",
        "<li>‚úîÔ∏è Validaci√≥n con las 10 librer√≠as de EasyStats</li>",
        "<li>‚úîÔ∏è Interpretaci√≥n con Inteligencia Artificial</li>",
        "</ul>",
        
        "<hr>",
        "<p style='text-align: center; color: #666; font-size: 14px;'>",
        "Generado el ", format(Sys.time(), "%d/%m/%Y %H:%M:%S"),
        "</p>",
        "</div>"
      ))
    })
  })
  
  # ========================================================================
  # DESCARGAR REPORTE
  # ========================================================================
  
  output$download_reporte <- downloadHandler(
    filename = function() {
      paste0("reporte_completo_", Sys.Date(), ".txt")
    },
    content = function(file) {
      req(datos(), modelo_actual())
      
      contenido <- paste(
        "====================================",
        "REPORTE COMPLETO DE AN√ÅLISIS",
        "====================================",
        "",
        "FECHA:", Sys.time(),
        "",
        "DATOS:",
        paste("Observaciones:", nrow(datos())),
        paste("Variables:", ncol(datos())),
        "",
        "MODELO:",
        capture.output(summary(modelo_actual())),
        "",
        "PERFORMANCE:",
        capture.output(performance(modelo_actual())),
        "",
        "PAR√ÅMETROS:",
        capture.output(parameters(modelo_actual())),
        "",
        "====================================",
        sep = "\n"
      )
      
      writeLines(contenido, file)
    }
  )
}

# ============================================================================
# EJECUTAR APLICACI√ìN
# ============================================================================

shinyApp(ui = ui, server = server)
